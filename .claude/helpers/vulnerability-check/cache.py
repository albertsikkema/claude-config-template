"""Simple file-based TTL cache for vulnerability feeds."""

import hashlib
import json
import os
import time
from pathlib import Path

CACHE_DIR = Path.home() / ".cache" / "vuln-check"


def _cache_path(key: str) -> Path:
    hashed = hashlib.sha256(key.encode()).hexdigest()
    return CACHE_DIR / f"{hashed}.json"


def get(key: str, ttl_seconds: int) -> object | None:
    path = _cache_path(key)
    if not path.exists():
        return None
    try:
        data = json.loads(path.read_text())
        if time.time() - data["ts"] < ttl_seconds:
            return data["data"]
    except (json.JSONDecodeError, KeyError, OSError):
        pass
    return None


def set(key: str, data: object) -> None:
    CACHE_DIR.mkdir(parents=True, exist_ok=True)
    payload = {"ts": time.time(), "data": data}
    _cache_path(key).write_text(json.dumps(payload))
