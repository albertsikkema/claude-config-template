"""Query GitHub Advisory Database for security advisories.

Usage: uv run python query_github.py [options]

Options:
  --keyword TEXT     Search keyword (package name, description)
  --ecosystem TEXT   Filter: npm, PyPI, Go, crates.io, Maven, RubyGems, NuGet
  --severity TEXT    Filter: low, medium, high, critical
  --cve TEXT         Search for a specific CVE ID
  --limit N          Max results (default 10)

Examples:
  uv run python query_github.py --keyword lodash --ecosystem npm
  uv run python query_github.py --keyword requests --ecosystem PyPI
  uv run python query_github.py --cve CVE-2024-1234
"""

import argparse
import json
import os
import sys

import httpx

# Map canonical (OSV-style) ecosystem names to GitHub Advisory API values.
# Accepts both forms so callers can use the same names as query_osv.py / parsers.py.
_ECOSYSTEM_TO_GITHUB = {
    "PyPI": "pip",
    "pypi": "pip",
    "pip": "pip",
    "npm": "npm",
    "Go": "go",
    "go": "go",
    "crates.io": "rust",
    "rust": "rust",
    "Maven": "maven",
    "maven": "maven",
    "RubyGems": "rubygems",
    "rubygems": "rubygems",
    "NuGet": "nuget",
    "nuget": "nuget",
}


def main():
    parser = argparse.ArgumentParser(description="Query GitHub Advisory Database")
    parser.add_argument("--keyword", default="")
    parser.add_argument("--ecosystem", default="")
    parser.add_argument("--severity", default="")
    parser.add_argument("--cve", default="")
    parser.add_argument("--limit", type=int, default=10)
    args = parser.parse_args()

    token = os.environ.get("GITHUB_TOKEN", "")
    fetch_count = min(args.limit * 5, 100) if args.keyword and not args.keyword.startswith("GHSA-") else min(args.limit, 100)

    params = {"per_page": fetch_count}
    if args.keyword and args.keyword.startswith("GHSA-"):
        params["ghsa_id"] = args.keyword
    if args.ecosystem:
        params["ecosystem"] = _ECOSYSTEM_TO_GITHUB.get(args.ecosystem, args.ecosystem)
    if args.severity:
        params["severity"] = args.severity
    if args.cve:
        params["cve_id"] = args.cve

    headers = {"Accept": "application/vnd.github+json"}
    if token:
        headers["Authorization"] = f"Bearer {token}"

    try:
        resp = httpx.get("https://api.github.com/advisories", params=params, headers=headers, timeout=30)
        if resp.status_code in (403, 429):
            print(json.dumps({"error": "Rate limit exceeded. Set GITHUB_TOKEN for higher limits."}))
            sys.exit(1)
        resp.raise_for_status()
    except httpx.HTTPStatusError as e:
        print(json.dumps({"error": f"HTTP {e.response.status_code}"}))
        sys.exit(1)
    except httpx.RequestError as e:
        print(json.dumps({"error": str(e)}))
        sys.exit(1)

    advisories = resp.json()

    # Client-side keyword filtering for non-GHSA keywords
    if args.keyword and not args.keyword.startswith("GHSA-"):
        kw = args.keyword.lower()
        advisories = [
            a for a in advisories
            if kw in a.get("summary", "").lower()
            or kw in a.get("description", "").lower()
            or any(kw in v.get("package", {}).get("name", "").lower() for v in a.get("vulnerabilities", []))
        ]

    advisories = advisories[:args.limit]

    results = []
    for adv in advisories:
        pkgs = []
        for vuln in adv.get("vulnerabilities", []):
            pkg = vuln.get("package", {})
            pkgs.append({
                "name": pkg.get("name", "?"),
                "ecosystem": pkg.get("ecosystem", "?"),
                "vulnerable_range": vuln.get("vulnerable_version_range", "?"),
                "first_patched": vuln.get("first_patched_version", None),
            })
        results.append({
            "ghsa_id": adv.get("ghsa_id", "?"),
            "cve_id": adv.get("cve_id"),
            "severity": adv.get("severity", "unknown"),
            "summary": adv.get("summary", ""),
            "packages": pkgs,
        })

    print(json.dumps({"count": len(results), "advisories": results}, indent=2))


if __name__ == "__main__":
    main()
