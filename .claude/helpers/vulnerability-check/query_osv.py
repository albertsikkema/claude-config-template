"""Query OSV.dev for known vulnerabilities in an open-source package.

Usage: uv run python query_osv.py <package> <ecosystem> [version]

Examples:
  uv run python query_osv.py lodash npm
  uv run python query_osv.py requests PyPI 2.31.0
"""

import json
import sys

import httpx


def main():
    if len(sys.argv) < 3:
        print("Usage: query_osv.py <package> <ecosystem> [version]", file=sys.stderr)
        sys.exit(1)

    package = sys.argv[1]
    ecosystem = sys.argv[2]
    version = sys.argv[3] if len(sys.argv) > 3 else ""

    payload = {"package": {"name": package, "ecosystem": ecosystem}}
    if version:
        payload["version"] = version

    try:
        resp = httpx.post("https://api.osv.dev/v1/query", json=payload, timeout=30)
        resp.raise_for_status()
    except httpx.HTTPStatusError as e:
        print(json.dumps({"error": f"HTTP {e.response.status_code}"}))
        sys.exit(1)
    except httpx.RequestError as e:
        print(json.dumps({"error": str(e)}))
        sys.exit(1)

    data = resp.json()
    vulns = data.get("vulns", [])

    results = []
    for v in vulns:
        severity = "unknown"
        for s in v.get("severity", []):
            if s.get("type") == "CVSS_V3":
                severity = s.get("score", severity)
                break
        fix_versions = []
        for affected in v.get("affected", []):
            for r in affected.get("ranges", []):
                for ev in r.get("events", []):
                    if "fixed" in ev:
                        fix_versions.append(ev["fixed"])
        results.append({
            "id": v.get("id", "?"),
            "summary": v.get("summary", ""),
            "severity": severity,
            "aliases": v.get("aliases", []),
            "fix_versions": fix_versions,
        })

    print(json.dumps({
        "package": package,
        "ecosystem": ecosystem,
        "version": version,
        "count": len(results),
        "vulnerabilities": results,
    }, indent=2))


if __name__ == "__main__":
    main()
