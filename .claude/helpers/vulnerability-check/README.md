# Vulnerability Check Scripts

Standalone Python scripts for querying security vulnerability databases. Used by the `/vulnerability-check` slash command in Claude Code.

## Data Sources

| Source | API | What it provides |
|--------|-----|------------------|
| [OSV.dev](https://osv.dev/) | `POST /v1/query`, `POST /v1/querybatch` | Open-source vulnerability database aggregating data from GitHub, PyPI, npm, Go, RubyGems, and more. Primary source for per-package and batch dependency scanning. |
| [GitHub Advisory Database](https://github.com/advisories) | `GET /advisories` | GitHub's curated security advisories with GHSA IDs, CVSS scores, and patch versions. Supports keyword, ecosystem, severity, and CVE filtering. Requires `GITHUB_TOKEN` env var for higher rate limits. |
| [CISA KEV](https://www.cisa.gov/known-exploited-vulnerabilities-catalog) | JSON feed | Known Exploited Vulnerabilities catalog maintained by CISA. If a CVE appears here, it is actively exploited in the wild and should be patched immediately. |
| [NCSC.nl](https://advisories.ncsc.nl/) | JSON feed | Dutch National Cyber Security Centre advisories. Provides probability and damage scores. Titles are typically in Dutch. |

## Supported Ecosystems

npm, PyPI, Go, crates.io, Maven, RubyGems, NuGet

All scripts accept the canonical ecosystem names above. `query_github.py` maps them internally to GitHub's API values (e.g. `PyPI` -> `pip`, `crates.io` -> `rust`).

## Supported Dependency Files

| File | Ecosystem | Version extraction |
|------|-----------|--------------------|
| `package.json` | npm | `dependencies` + `devDependencies`, strips `^~>=<` prefixes |
| `requirements.txt` | PyPI | `==` pinned versions; unpinned packages get empty version |
| `pyproject.toml` | PyPI | PEP 621 `[project].dependencies` (`==`, `>=`, `~=`) + Poetry `[tool.poetry.dependencies]` |
| `go.mod` | Go | `require` blocks, strips `v` prefix |
| `Cargo.toml` | crates.io | `dependencies`, `dev-dependencies`, `build-dependencies` |
| `Gemfile.lock` | RubyGems | `specs:` section with exact versions |
| `pom.xml` | Maven | `<dependency>` elements with `groupId:artifactId` |

## Scripts

| Script | Purpose | Usage |
|--------|---------|-------|
| `query_osv.py` | Query a single package against OSV.dev | `query_osv.py <package> <ecosystem> [version]` |
| `query_github.py` | Search GitHub Advisory Database | `query_github.py --keyword TEXT --ecosystem TEXT --severity TEXT --cve TEXT --limit N` |
| `query_cisa.py` | Search CISA KEV catalog | `query_cisa.py --keyword TEXT --cve TEXT --vendor TEXT --product TEXT --limit N` |
| `query_ncsc.py` | Search NCSC.nl advisories | `query_ncsc.py --severity N --keyword TEXT --limit N` |
| `scan_deps.py` | Scan a dependency file via OSV batch API | `scan_deps.py <file_path> [--max-per-pkg N]` |
| `native_audit.py` | Run ecosystem-native audit tool | `native_audit.py <file_path>` |

Supporting modules:

| File | Purpose |
|------|---------|
| `parsers.py` | Dependency file parsers for 7 formats |
| `osv_utils.py` | Shared OSV vulnerability data extraction |
| `cache.py` | File-based TTL cache for large feeds (CISA, NCSC) |

## How It Works

All scripts are invoked via `uv run` and output JSON to stdout:

```bash
uv run --project .claude/helpers/vulnerability-check \
  python .claude/helpers/vulnerability-check/<script> [args]
```

### Single package lookup

```bash
# Check a specific package (all known vulns)
query_osv.py requests PyPI

# Check a specific version (only vulns affecting that version)
query_osv.py requests PyPI 2.31.0

# Get GitHub advisory details
query_github.py --keyword requests --ecosystem PyPI
```

### CVE investigation

```bash
# Check if a CVE is actively exploited
query_cisa.py --cve CVE-2021-44228

# Get advisory details
query_github.py --cve CVE-2021-44228
```

### Full dependency scan

```bash
# Scan a single file
scan_deps.py ./package.json

# Scan with more results per package
scan_deps.py ./requirements.txt --max-per-pkg 10
```

### Slash command

The `/vulnerability-check` slash command orchestrates these scripts. It accepts:

- **No arguments** — finds all dependency files in the project, scans each, cross-references CVEs against CISA KEV
- **A package name** (e.g. `lodash`) — queries OSV + GitHub
- **A CVE ID** (e.g. `CVE-2024-1234`) — queries CISA + GitHub
- **A file path** — runs `scan_deps.py` on it

## Native Audit Tools

`native_audit.py` wraps ecosystem-native audit tools and normalizes their output to a common JSON format. If a tool is not installed, it returns `{"status": "skipped"}` gracefully instead of failing.

None of the tools below are required — if a tool is missing, the script skips that ecosystem. Only install the ones matching ecosystems you actually use.

| Dependency File | Tool | Install |
|----------------|------|---------|
| `package.json` | `npm audit` | Built into npm (comes with Node.js) |
| `requirements.txt` | `pip-audit` | `pip install pip-audit` |
| `pyproject.toml` | `pip-audit` | `pip install pip-audit` |
| `go.mod` | `govulncheck` | `go install golang.org/x/vuln/cmd/govulncheck@latest` |
| `Cargo.toml` | `cargo-audit` | `cargo install cargo-audit` |
| `Gemfile.lock` | `bundler-audit` | `gem install bundler-audit` |
| `pom.xml` | _(not supported)_ | — |

### Prerequisites

```bash
# Node.js / npm — npm audit is built-in, nothing extra needed
npm --version

# Python
pip install pip-audit

# Go
go install golang.org/x/vuln/cmd/govulncheck@latest

# Rust
cargo install cargo-audit

# Ruby
gem install bundler-audit
```

```bash
# Run native audit on a dependency file
native_audit.py ./package.json

# Example output
{
  "file": "/path/to/package.json",
  "ecosystem": "npm",
  "tool": "npm",
  "status": "completed",
  "vulnerability_count": 3,
  "vulnerabilities": [...]
}
```

## Caching

CISA KEV and NCSC feeds are cached locally in `~/.cache/vuln-check/` with TTLs:

| Feed | TTL |
|------|-----|
| CISA KEV | 6 hours |
| NCSC.nl | 1 hour |

OSV and GitHub queries are not cached (they are fast and results change frequently).

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `GITHUB_TOKEN` | No | GitHub personal access token. Without it, `query_github.py` is limited to 60 requests/hour. With it, 5,000/hour. |
