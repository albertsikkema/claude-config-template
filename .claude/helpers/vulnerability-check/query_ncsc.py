"""Query NCSC.nl (Dutch National Cyber Security Centre) advisories.

Usage: uv run python query_ncsc.py [options]

Options:
  --severity N      Filter by damage score: 1 (low), 2 (high)
  --keyword TEXT    Search keyword in advisory titles
  --limit N         Max results (default 20)

Examples:
  uv run python query_ncsc.py --severity 2
  uv run python query_ncsc.py --keyword apache --limit 5

Note: NCSC response format is [id, version, title, date, probability, damage].
Titles are typically in Dutch.
"""

import argparse
import json
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).resolve().parent))

import httpx

import cache

NCSC_TTL = 3600  # 1 hour

# NCSC uses numeric scores: 0=unknown, 1=low, 2=high
SEVERITY_LABELS = {0: "unknown", 1: "low", 2: "high"}


def main():
    parser = argparse.ArgumentParser(description="Query NCSC.nl advisories")
    parser.add_argument("--severity", type=int, default=0, help="Damage score: 0=unknown, 1=low, 2=high")
    parser.add_argument("--keyword", default="")
    parser.add_argument("--limit", type=int, default=20)
    args = parser.parse_args()

    cache_key = "ncsc_advisories"
    data = cache.get(cache_key, NCSC_TTL)
    if data is None:
        try:
            resp = httpx.get("https://advisories.ncsc.nl/advisories.json", timeout=30)
            resp.raise_for_status()
            data = resp.json()
            cache.put(cache_key, data)
        except httpx.HTTPStatusError as e:
            print(json.dumps({"error": f"HTTP {e.response.status_code}"}))
            sys.exit(1)
        except httpx.RequestError as e:
            print(json.dumps({"error": str(e)}))
            sys.exit(1)

    # Format: list of [id, version, title, date, probability, damage]
    advisories = data

    if args.severity:
        advisories = [a for a in advisories if len(a) > 5 and a[5] == args.severity]

    if args.keyword:
        kw = args.keyword.lower()
        advisories = [a for a in advisories if len(a) > 2 and kw in a[2].lower()]

    advisories = advisories[:args.limit]

    results = []
    for a in advisories:
        results.append({
            "id": a[0] if len(a) > 0 else "?",
            "version": a[1] if len(a) > 1 else "?",
            "title": a[2] if len(a) > 2 else "",
            "published": a[3] if len(a) > 3 else "?",
            "probability": SEVERITY_LABELS.get(a[4], str(a[4])) if len(a) > 4 else "unknown",
            "damage": SEVERITY_LABELS.get(a[5], str(a[5])) if len(a) > 5 else "unknown",
        })

    print(json.dumps({"count": len(results), "advisories": results}, indent=2))


if __name__ == "__main__":
    main()
