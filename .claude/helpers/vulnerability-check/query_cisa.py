"""Query CISA Known Exploited Vulnerabilities (KEV) catalog.

Usage: uv run python query_cisa.py [options]

Options:
  --keyword TEXT   Search across all fields
  --cve TEXT       Search for a specific CVE ID
  --vendor TEXT    Filter by vendor
  --product TEXT   Filter by product
  --limit N        Max results (default 20)

Examples:
  uv run python query_cisa.py --cve CVE-2024-1234
  uv run python query_cisa.py --vendor apache --limit 10
  uv run python query_cisa.py --keyword log4j
"""

import argparse
import json
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).resolve().parent))

import httpx

import cache

CISA_KEV_TTL = 21600  # 6 hours


def main():
    parser = argparse.ArgumentParser(description="Query CISA KEV catalog")
    parser.add_argument("--keyword", default="")
    parser.add_argument("--cve", default="")
    parser.add_argument("--vendor", default="")
    parser.add_argument("--product", default="")
    parser.add_argument("--limit", type=int, default=20)
    args = parser.parse_args()

    cache_key = "cisa_kev"
    data = cache.get(cache_key, CISA_KEV_TTL)
    if data is None:
        try:
            resp = httpx.get(
                "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json",
                timeout=30,
            )
            resp.raise_for_status()
            data = resp.json()
            cache.set(cache_key, data)
        except httpx.HTTPStatusError as e:
            print(json.dumps({"error": f"HTTP {e.response.status_code}"}))
            sys.exit(1)
        except httpx.RequestError as e:
            print(json.dumps({"error": str(e)}))
            sys.exit(1)

    vulns = data.get("vulnerabilities", [])

    if args.cve:
        cve_upper = args.cve.upper()
        vulns = [v for v in vulns if v.get("cveID", "").upper() == cve_upper]
    if args.vendor:
        vendor_lower = args.vendor.lower()
        vulns = [v for v in vulns if vendor_lower in v.get("vendorProject", "").lower()]
    if args.product:
        product_lower = args.product.lower()
        vulns = [v for v in vulns if product_lower in v.get("product", "").lower()]
    if args.keyword:
        kw = args.keyword.lower()
        vulns = [
            v for v in vulns
            if kw in v.get("vulnerabilityName", "").lower()
            or kw in v.get("shortDescription", "").lower()
            or kw in v.get("cveID", "").lower()
            or kw in v.get("vendorProject", "").lower()
            or kw in v.get("product", "").lower()
        ]

    vulns = vulns[:args.limit]

    results = []
    for v in vulns:
        results.append({
            "cve_id": v.get("cveID", "?"),
            "name": v.get("vulnerabilityName", "?"),
            "vendor": v.get("vendorProject", "?"),
            "product": v.get("product", "?"),
            "description": v.get("shortDescription", ""),
            "date_added": v.get("dateAdded", "?"),
            "due_date": v.get("dueDate", "?"),
            "required_action": v.get("requiredAction", ""),
        })

    print(json.dumps({"count": len(results), "vulnerabilities": results}, indent=2))


if __name__ == "__main__":
    main()
